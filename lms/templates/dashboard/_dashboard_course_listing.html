<%page args="course_overview, enrollment, show_courseware_link, cert_status, can_unenroll, credit_status, show_email_settings, course_mode_info, show_refund_option, is_paid_course, is_course_blocked, verification_status, course_requirements, dashboard_index, share_settings, related_programs, display_course_modes_on_dashboard" expression_filter="h"/>

<%!
import urllib

from django.utils.translation import ugettext as _
from django.utils.translation import ungettext
from django.core.urlresolvers import reverse
from course_modes.models import CourseMode
from course_modes.helpers import enrollment_mode_display
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.djangolib.markup import HTML, Text
from openedx.features.course_experience import course_home_url_name
from student.helpers import (
  VERIFY_STATUS_NEED_TO_VERIFY,
  VERIFY_STATUS_SUBMITTED,
  VERIFY_STATUS_RESUBMITTED,
  VERIFY_STATUS_APPROVED,
  VERIFY_STATUS_MISSED_DEADLINE,
  VERIFY_STATUS_NEED_TO_REVERIFY,
  DISABLE_UNENROLL_CERT_STATES,
)
from util.course import get_link_for_about_page, get_encoded_course_sharing_utm_params
%>

<%
  reverify_link = reverse('verify_student_reverify')
  cert_name_short = course_overview.cert_name_short
  if cert_name_short == "":
    cert_name_short = settings.CERT_NAME_SHORT

  cert_name_long = course_overview.cert_name_long
  if cert_name_long == "":
    cert_name_long = settings.CERT_NAME_LONG
  billing_email = settings.PAYMENT_SUPPORT_EMAIL
%>

<%namespace name='static' file='../static_content.html'/>

<li class="course-item">
  % if display_course_modes_on_dashboard:
    <%
        course_verified_certs = enrollment_mode_display(
            enrollment.mode,
            verification_status.get('status'),
            course_overview.id
        )
    %>
    <%
        mode_class = course_verified_certs.get('display_mode', '')
        if mode_class != '':
            mode_class = ' ' + mode_class ;
    %>
  % else:
    <% mode_class = '' %>
  % endif
      <div class="course-container"
        % if getattr(course_overview, 'language'):
          lang="${course_overview.language}"
        % endif
      >
<article class="course${mode_class}">
  <% course_target = reverse(course_home_url_name(course_overview.id), args=[unicode(course_overview.id)]) %>
  <section class="details" aria-labelledby="details-heading-${course_overview.number}">
      <h2 class="hd hd-2 sr" id="details-heading-${course_overview.number}">${_('Course details')}</h2>
    <div class="wrapper-course-image" aria-hidden="true">
      % if show_courseware_link:
        % if not is_course_blocked:
            <a href="${course_target}" data-course-key="${enrollment.course_id}" class="cover">
              <img src="${course_overview.image_urls['small']}" class="course-image" alt="${_('{course_number} {course_name} Home Page').format(course_number=course_overview.number, course_name=course_overview.display_name_with_default)}" />
            </a>
        % else:
            <a class="fade-cover">
              <img src="${course_overview.image_urls['small']}" class="course-image" alt="${_('{course_number} {course_name} Cover Image').format(course_number=course_overview.number, course_name=course_overview.display_name_with_default)}" />
            </a>
        % endif
      % else:
        <a class="cover">
          <img src="${course_overview.image_urls['small']}" class="course-image" alt="${_('{course_number} {course_name} Cover Image').format(course_number=course_overview.number, course_name=course_overview.display_name_with_default)}" />
        </a>
      % endif
      % if display_course_modes_on_dashboard and course_verified_certs.get('display_mode') != 'audit':
        <span class="sts-enrollment" title="${course_verified_certs.get('enrollment_title')}">
          <span class="label">${_("Enrolled as: ")}</span>
          % if course_verified_certs.get('show_image'):
              <img class="deco-graphic" src="${static.url('images/verified-ribbon.png')}" alt="${course_verified_certs.get('image_alt')}" />
          % endif
          <div class="sts-enrollment-value">${course_verified_certs.get('enrollment_value')}</div>
        </span>
      % endif
    </div>
      <div class="wrapper-course-details">
        <h3 class="course-title">
            <div class="info-course-id">${course_overview.display_number_with_default}</div>
          % if show_courseware_link:
            % if not is_course_blocked:
              <a data-course-key="${enrollment.course_id}" href="${course_target}">${course_overview.display_name_with_default}</a>
            % else:
              <a class="disable-look" data-course-key="${enrollment.course_id}">${course_overview.display_name_with_default}</a>
            % endif
          % else:
            <span>${course_overview.display_name_with_default}</span>
          % endif
          <div class="info-holder">
            <span class="info-university">${course_overview.display_org_with_default} - </span>


          
          <%
            if course_overview.start_date_is_still_default:
                container_string = _("Coming Soon")
                course_date = None
            else:
                format = 'shortDate'
                if course_overview.has_ended():
                    container_string = _("Ended - {date}")
                    course_date = course_overview.end
                elif course_overview.has_started():
                    container_string = _("Started - {date}")
                    course_date = course_overview.dashboard_start_display
                elif course_overview.starts_within(days=5):
                    container_string = _("Starts - {date}")
                    course_date = course_overview.dashboard_start_display
                    format = 'defaultFormat'
                else: ## hasn't started yet
                    container_string = _("Starts - {date}")
                    course_date = course_overview.dashboard_start_display
                endif
            endif
          %>

                % if isinstance(course_date, basestring):
                    <span class="info-date-block" data-tooltip="Hi">${_(container_string).format(date=course_date)}</span>
                % elif course_date is not None:
                    <%
                        course_date_string = course_date.strftime('%Y-%m-%dT%H:%M:%S%z')
                    %>
                    <span class="info-date-block localized-datetime" data-language="${user_language}" data-tooltip="Hi" data-timezone="${user_timezone}" data-datetime="${course_date_string}" data-format=${format} data-string="${container_string}"></span>
                %else:
                    <span class="info-date-block" data-tooltip="Hi">${container_string}</span>
                % endif
          </div>
        </h3>
          <div class="course-info">
            <%
                is_audit = (
                    pageargs['verification_state'] == 'denied'
                    or verification_status.get('status','') == VERIFY_STATUS_MISSED_DEADLINE
                )

                is_purshue_credit = (
                    (
                        (course_mode_info['show_upsell'] and not is_course_blocked)
                        or (pageargs['verification_state'] in ['must_reverify', 'must_retry'])
                        or (verification_status.get('status','') == VERIFY_STATUS_NEED_TO_VERIFY)
                    )
                    and not is_audit
                )
                is_credit_pending = (
                    credit_status and credit_status["request_status"] == 'pending'
                )

                is_id_verification_pending = pageargs["verification_state"] == 'pending'
                is_id_verification_approved = pageargs['verification_state'] == 'approved'

                is_credit_converted = credit_status and credit_status["request_status"] == 'approved'

                credit_btn_label = None
                if credit_status and credit_status["eligible"]:
                    provider_link = '<a href="{href}" target="_blank">{name}</a>'.format(
                        href=credit_status["provider_status_url"],
                        name=credit_status["provider_name"])

                    error = credit_status['error']

                    # Translators: provider_name is the name of a credit provider or university (e.g. State University)
                    credit_msg = _("You have completed this course and are eligible to purchase course credit. Select <strong>Get Credit</strong> to get started.")
                    if credit_status['provider_name']:
                        credit_msg = _("You are now eligible for credit from {provider}. Congratulations!").format(provider=credit_status['provider_name'])

                    credit_msg_class = "credit-eligibility-msg"
                    credit_btn_class = "enter-course"
                    credit_btn_label = _("Get Credit")
                    ecommerce_url_root = static.get_value('ECOMMERCE_PUBLIC_URL_ROOT', settings.ECOMMERCE_PUBLIC_URL_ROOT)
                    credit_btn_href = '{root}/credit/checkout/{course_id}/'.format(
                        root=ecommerce_url_root,
                        course_id=credit_status['course_key'])

                    if credit_status["purchased"]:
                        request_status = credit_status["request_status"]
                        if request_status is None:
                            # Learner must initiate the credit request

                            # Translators: link_to_provider_site is a link to an external webpage. The text of the link will be the name of a  credit provider, such as 'State University' or 'Happy Fun Company'.
                            credit_msg = _("Thank you for your payment. To receive course credit, you must now request credit "
                            "at the {link_to_provider_site} website. Select <b>Request Credit</b> to get started.").format(
                                link_to_provider_site=provider_link,
                            )
                            credit_msg_class = "credit-request-not-started-msg"
                            credit_btn_label = _("Request Credit")
                            credit_btn_class = 'enter-course request-credit-btn'
                            credit_btn_href = None
                        elif request_status == 'pending':
                            # Request received but not reviewed
                            ## Translators: provider_name is the name of a credit provider or university (e.g. State University)
                            credit_msg = _("{provider_name} has received your course credit request. We will update you when credit processing is complete.").format(provider_name=credit_status["provider_name"])
                            credit_msg_class = "credit-request-pending-msg"
                            credit_btn_label = _("View Details")
                            credit_btn_class = 'pending-credit-btn'
                        elif request_status == 'approved':
                            # Credit granted!
                            # Translators: link_to_provider_site is a link to an external webpage. The text of the link will be the name of a credit provider, such as 'State University' or 'Happy Fun Company'. provider_name is the name of credit provider.
                            credit_msg = _("<b>Congratulations!</b> {provider_name} has approved your request for course credit. To see your course credit, visit the {link_to_provider_site} website.").format(
                                provider_name=credit_status["provider_name"],
                                link_to_provider_site=provider_link,
                            )
                            credit_msg_class = "credit-request-approved-msg"
                            credit_btn_href = credit_status['provider_status_url']
                            credit_btn_label = _("View Credit")
                        elif request_status == 'rejected':
                            # REJECTED (by the credit provider)!
                            ## Translators: link_to_provider_site is a link to an external webpage. The text of the link will be the name of a credit provider, such as 'State University' or 'Happy Fun Company'. provider_name is the name of credit provider.
                            credit_msg = _("{provider_name} did not approve your request for course credit. For more information, contact {link_to_provider_site} directly.").format(
                                provider_name=credit_status["provider_name"],
                                link_to_provider_site=provider_link,
                            )
                            credit_msg_class = "credit-request-rejected-msg"
                            credit_btn_label = None


            %>
            % if is_purshue_credit:
                <p class="action-req">${_('Action required')}</p>
                <p>${_('Click the Pursue credit button to complete your courses on the Credit Eligible Track')}</p>
            %elif is_audit:
                <p class="action-req">${_('Action required')}</p>
                <p>${_('It looks like you tried to verify your identity but were unsuccessful. The deadline to ID verify has now passed. Call us at 1-844-448-7707.')}</p>
            %elif is_id_verification_pending:
                <p class="action-req" style="display:none">${_('Action required')} </p>
                <p>${_('ID Verify Status Pending. We are reviewing your ID information.')}</p>
            %elif is_credit_pending:
              <p class="action-req action-req--green">${_('Action requiered')} </p>
              <p>${_('No action required; it may take up to 10 business days to process your credit.')}</p>
            %elif credit_btn_label:
                <p class="action-req">${_('Action required')} </p>
                <p>${_('Before you get your credit, check our')} <a class="action-req-link" href="https://ea.asu.edu/gpa-calculator">GPA calculator</a> ${_('to ensure the credit you’ve earned will help you gain admission to ASU; otherwise, you may consider repeating the course.')}</p>
            %elif is_credit_pending:
                <p class="action-req action-req--green">${_('Action required')} </p>
                <p>${_('ID Verify Status Pending. We are reviewing your ID information.')}</p>
            %else:
              <p class="action-req" style="display:none" >${_('Action required')} </p>
              <p></p>
            %endif

        </div>
        <div class="wrapper-course-actions">
          <div class="course-actions">
              %if is_purshue_credit:
                   <a class="enter-course" href="${reverse('verify_student_upgrade_and_verify', kwargs={'course_id': unicode(course_overview.id)})}"  data-course-id="${course_overview.id}" data-user="${user.username}">
                       <span>${_('Pursue credit')}</span>
                   </a>
              %elif is_audit:
                   <a class="enter-course" href="${course_target}"  data-course-id="${course_overview.id}" data-user="${user.username}">
                       <span>${_('Audit course')}</span>
                   </a>
              %elif is_credit_converted:
                   <a class="enter-course" href="https://go.oasis.asu.edu/unofficialtranscript/"  data-course-id="${course_overview.id}" data-user="${user.username}">
                       <span>${_('View Transcript')}</span>
                   </a>
              % elif credit_btn_label:
                <a class="btn credit-btn ${credit_btn_class}" href="${credit_btn_href | h}" target="_blank" data-course-key="${credit_status['course_key'] | h}" data-user="${user.username | h}" data-provider="${credit_status['provider_id'] | h}">
                    <span>${credit_btn_label}</span>
                </a>
              % elif is_credit_pending:
                <span class="enter-course enter-course--disabled" data-course-key="${credit_status['course_key'] | h}" data-user="${user.username | h}" data-provider="${credit_status['provider_id'] | h}">
                    <span>${_('Get credit')}</span>
                </span>
              %elif show_courseware_link:
                      % if course_overview.has_ended():
                          % if not is_course_blocked:
                              <a href="${course_target}" class="enter-course archived"
                                 data-course-key="${enrollment.course_id}">${_('View Archived Course')}<span class="sr">&nbsp;${course_overview.display_name_with_default}</span></a>
                          % else:
                              <a class="enter-course-blocked archived"
                                 data-course-key="${enrollment.course_id}">${_('View Archived Course')}<span class="sr">&nbsp;${course_overview.display_name_with_default}</span></a>
                          % endif
                      % else:
                          % if not is_course_blocked:
                              <a href="${course_target}" class="enter-course"
                                 data-course-key="${enrollment.course_id}">${_('View Course')}<span
                                  class="sr">&nbsp;${course_overview.display_name_with_default}</span></a>
                          % else:
                              <a class="enter-course-blocked"
                                 data-course-key="${enrollment.course_id}">${_('View Course')}<span
                                  class="sr">&nbsp;${course_overview.display_name_with_default}</span></a>
                          % endif
                      % endif
                  % endif

            % if show_courseware_link or course_overview.has_social_sharing_url() or course_overview.has_marketing_url():

                % if share_settings:
                    <%
                      share_url = get_link_for_about_page(course_overview)
                      encoded_utm_parameters = get_encoded_course_sharing_utm_params()
                      share_window_name = 'shareWindow'
                      share_window_config = 'toolbar=no, location=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=640, height=480'
                    %>
                    % if share_settings.get('DASHBOARD_FACEBOOK', False):
                        <%
                          facebook_share_url = "{url}?{utm_params}".format(url=share_url.encode('utf-8'), utm_params=encoded_utm_parameters['facebook'])
                          share_text = _("I'm taking {course_name} online with edX.org. Check it out!").format(course_name=course_overview.display_name_with_default)
                          query_params = urllib.urlencode((('u', facebook_share_url), ('quote', share_text.encode('utf-8')),))
                          facebook_url = 'https://www.facebook.com/sharer/sharer.php?{query}'.format(query=query_params)
                        %>
                        <a
                          data-tooltip="${_('Share on Facebook')}"
                          class="action action-facebook"
                          aria-haspopup="true"
                          aria-expanded="false"
                          href="${facebook_url}"
                          target="_blank"
                          title="${_('Share on Facebook')}"
                          data-course-id="${course_overview.id}"
                          onclick="window.open('${facebook_url}', '${share_window_name}', '${share_window_config}'); return false;">
                          <span class="sr">${_('Facebook')}</span>
                          <span class="fa fa-facebook" aria-hidden="true"></span>
                        </a>
                    % endif
                    % if share_settings.get('DASHBOARD_TWITTER', False):
                        <%
                          twitter_share_url = "{url}?{utm_params}".format(url=share_url.encode('utf-8'), utm_params=encoded_utm_parameters['twitter'])
                          default_share_text = _("I'm taking {course_name} online with @edxonline. Check it out!").format(course_name=course_overview.display_name_with_default)
                          share_text = urllib.quote_plus(share_settings.get('DASHBOARD_TWITTER_TEXT', default_share_text.encode('utf-8')))
                          twitter_url = 'https://twitter.com/intent/tweet?text=' + share_text + '%20' + urllib.quote_plus(twitter_share_url)
                        %>
                        <a
                          data-tooltip="${_('Share on Twitter')}"
                          class="action action-twitter"
                          aria-haspopup="true"
                          aria-expanded="false"
                          href="${twitter_url}"
                          target="_blank"
                          title="${_('Share on Twitter')}"
                          data-course-id="${course_overview.id}"
                          onclick="window.open('${twitter_url}', '${share_window_name}', '${share_window_config}'); return false;">
                          <span class="sr">${_('Twitter')}</span>
                          <span class="fa fa-twitter" aria-hidden="true"></span>
                        </a>
                    % endif
                % endif

            % endif
            <div class="wrapper-action-more" data-course-key="${enrollment.course_id}"></div>
          </div>
        </div>
      </div>
  </section>
</article>
</div>
</li>

<script>
           $( document ).ready(function() {

               if("${is_course_blocked | n, dump_js_escaped_json}" == 'true'){
                   $( "#unregister_block_course" ).click(function() {
                       $('.disable-look-unregister').click();
                   });
               }

           });
</script>

% if share_settings.get('DASHBOARD_FACEBOOK', False) and share_settings.get('DASHBOARD_TWITTER', False):
    <%static:require_module_async module_name="js/course_sharing/course_sharing_events" class_name="CourseSharingEvents">
        CourseSharingEvents("${course_overview.id | n, js_escaped_string}");
    </%static:require_module_async>
%endif

<%static:require_module_async module_name="js/dateutil_factory" class_name="DateUtilFactory">
    DateUtilFactory.transform(iterationKey=".localized-datetime");
</%static:require_module_async>
