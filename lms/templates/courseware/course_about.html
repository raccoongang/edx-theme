<%namespace name='static' file='../static_content.html'/>
<%!
from django.template.defaultfilters import truncatechars
from django.utils.translation import ugettext as _
from django.core.urlresolvers import reverse
from courseware.courses import get_course_about_section
from django.conf import settings
from edxmako.shortcuts import marketing_link
from openedx.core.lib.courses import course_image_url
from django.template.defaultfilters import truncatechars
%>

<%inherit file="../main.html" />
<%block name="headextra">
  ## OG (Open Graph) title and description added below to give social media info to display
  ## (https://developers.facebook.com/docs/opengraph/howtos/maximizing-distribution-media-content#tags)
  <meta property="og:title" content="${course.display_name_with_default_escaped}" />
  <meta property="og:description" content="${get_course_about_section(request, course, 'short_description')}" />
</%block>

<%block name="js_extra">
  ## CourseTalk widget js script
  % if show_coursetalk_widget:
      <script src="//d3q6qq2zt8nhwv.cloudfront.net/s/js/widgets/coursetalk-read-reviews.js"></script>
  % endif
  <script type="text/javascript">
  (function() {
    // $(".open-box_link").click(function() {
    //   $(this).parent().slideToggle( "fast", function() {});
    // });

        // var expanders = document.querySelectorAll('.open-box_link');
    // if (expanders) {
    //     [].slice.call(expanders).forEach(function(exp) {
    //         exp.addEventListener('click', function() {
    //             exp.parentNode.classList.toggle('open-box__show');
    //         });
    //     });
    // }
    // $(".open-box_link").bind("click", function(e){
    //     var boxHeight = $(this).parent().height();
    //     console.log(boxHeight)
    //     $(this).parent().css("height", boxHeight); 
    // });

    
    
    //   $(".open-box_link").click(function(){
    //     console.log('click');
    //     if($(this).parent().height() === 0){
    //       autoHeightAnimate($(this).parent(), 500);
    //     } else {
    //       $(this).parent().stop().animate({ height: '150' }, 500);
    //     }
    //   });

    //   /* Function to animate height: auto */
    // function autoHeightAnimate(element, time){
    //     var curHeight = element.height(), // Get Default Height
    //         autoHeight = element.css('height', 'auto').height(); // Get Auto Height
    //         element.height(curHeight); // Reset to Default Height
    //         element.stop().animate({ height: autoHeight }, time);
    // };

    // This is the important part!

function collapseSection(element) {
  // get the height of the element's inner content, regardless of its actual size
  var sectionHeight = element.scrollHeight;
  
  // temporarily disable all css transitions
  var elementTransition = element.style.transition;
  element.style.transition = '';
  
  // on the next frame (as soon as the previous style change has taken effect),
  // explicitly set the element's height to its current pixel height, so we 
  // aren't transitioning out of 'auto'
  requestAnimationFrame(function() {
    element.style.height = sectionHeight + 'px';
    element.style.transition = elementTransition;
    
    // on the next frame (as soon as the previous style change has taken effect),
    // have the element transition to height: 0
    requestAnimationFrame(function() {
      element.style.height = 150 + 'px';
    });
  });
  
  // mark the section as "currently collapsed"
  element.setAttribute('data-collapsed', 'true');
}

function expandSection(element) {
  // get the height of the element's inner content, regardless of its actual size
  var sectionHeight = element.scrollHeight;
  
  // have the element transition to the height of its inner content
  element.style.height = sectionHeight + 'px';

  // when the next css transition finishes (which should be the one we just triggered)
  element.addEventListener('transitionend', function(e) {
    // remove this event listener so it only gets triggered once
    element.removeEventListener('transitionend', arguments.callee);
    
    // remove "height" from the element's inline styles, so it can return to its initial value
    element.style.height = null;
  });
  
  // mark the section as "currently not collapsed"
  element.setAttribute('data-collapsed', 'false');
}
$(".open-box_link").click(function() {
  var section = document.querySelector('.open-box');
  var isCollapsed = section.getAttribute('data-collapsed') === 'true';
  if(isCollapsed) {
    expandSection(section)
    section.setAttribute('data-collapsed', 'false')
  } else {
    collapseSection(section)
  }
});

      
    $(".register").click(function(event) {
      $("#class_enroll_form").submit();
      event.preventDefault();
    });

    % if can_add_course_to_cart:
      add_course_complete_handler = function(jqXHR, textStatus) {
        if (jqXHR.status == 200) {
          location.href = "${cart_link}";
        }
        if (jqXHR.status == 400) {
          $("#register_error")
            .html(jqXHR.responseText ? jqXHR.responseText : "${_("An error occurred. Please try again later.")}")
            .css("display", "block");
        }
        else if (jqXHR.status == 403) {
            location.href = "${reg_then_add_to_cart_link}";
        }
      };

      $("#add_to_cart_post").click(function(event){
        $.ajax({
          url: "${reverse('add_course_to_cart', args=[course.id.to_deprecated_string()])}",
          type: "POST",
          /* Rant: HAD TO USE COMPLETE B/C PROMISE.DONE FOR SOME REASON DOES NOT WORK ON THIS PAGE. */
          complete: add_course_complete_handler
        })
        event.preventDefault();
      });
    % endif

    ## making the conditional around this entire JS block for sanity
    %if settings.FEATURES.get('RESTRICT_ENROLL_BY_REG_METHOD') and course.enrollment_domain:
      <%
        perms_error = _('The currently logged-in user account does not have permission to enroll in this course. '
                        'You may need to {start_logout_tag}log out{end_tag} then try the enroll button again. '
                        'Please visit the {start_help_tag}help page{end_tag} for a possible solution.').format(
                          start_help_tag="<a href='{url}'>".format(url=marketing_link('FAQ')), end_tag='</a>',
                          start_logout_tag="<a href='{url}'>".format(url=reverse('logout'))
                          )
      %>
    $('#class_enroll_form').on('ajax:complete', function(event, xhr) {
      if(xhr.status == 200) {
        location.href = "${reverse('dashboard')}";
      } else if (xhr.status == 403) {
        location.href = "${reverse('course-specific-register', args=[course.id.to_deprecated_string()])}?course_id=${course.id | u}&enrollment_action=enroll";
      } else if (xhr.status == 400) { //This means the user did not have permission
        $('#register_error').html("${perms_error}").css("display", "block");
      } else {
        $('#register_error').html(
            (xhr.responseText ? xhr.responseText : "${_("An error occurred. Please try again later.")}")
        ).css("display", "block");
      }
    });

    %else:

    $('#class_enroll_form').on('ajax:complete', function(event, xhr) {
      if(xhr.status == 200) {
        if (xhr.responseText == "") {
          location.href = "${reverse('dashboard')}";
        }
        else {
          location.href = xhr.responseText;
        }
      } else if (xhr.status == 403) {
          location.href = "${reverse('register_user')}?course_id=${course.id | u}&enrollment_action=enroll";
      } else {
        $('#register_error').html(
            (xhr.responseText ? xhr.responseText : "${_("An error occurred. Please try again later.")}")
        ).css("display", "block");
      }
    });

    %endif

  })(this)
  </script>

  <script src="${static.url('js/course_info.js')}"></script>
</%block>

<%block name="pagetitle">${course.display_name_with_default_escaped}</%block>

<section class="course-info">
  <header class="course-profile">
    <div class="intro-inner-wrapper">
      <div class="table">
      <section class="intro">
        <div class="heading-group">
          <h1>
            ${truncatechars(course.display_name_with_default_escaped, 20)}
            <a href="#">${course.display_org_with_default | h}</a>
          </h1>
          <br>
          <h3>
            ${get_course_about_section(request, course, 'short_description')}
          </h3>
        </div>

        <div class="main-cta">
        %if user.is_authenticated() and registered:
          %if show_courseware_link:
            <a href="${course_target}">
          %endif

          <span class="register disabled">${_("You are enrolled in this course")}</span>

          %if show_courseware_link:
            <strong>${_("View Course")}</strong>
            </a>
          %endif

        %elif in_cart:
          <span class="add-to-cart">
            ${_('This course is in your <a href="{cart_link}">cart</a>.').format(cart_link=cart_link)}
          </span>
        % elif is_course_full:
          <span class="register disabled">
            ${_("Course is full")}
          </span>
        % elif invitation_only and not can_enroll:
          <span class="register disabled">${_("Enrollment in this course is by invitation only")}</span>
        ## Shib courses need the enrollment button to be displayed even when can_enroll is False,
        ## because AnonymousUsers cause can_enroll for shib courses to be False, but we need them to be able to click
        ## so that they can register and become a real user that can enroll.
        % elif not is_shib_course and not can_enroll:
          <span class="register disabled">${_("Enrollment is Closed")}</span>
        %elif can_add_course_to_cart:
          <%
          if user.is_authenticated():
            reg_href = "#"
            reg_element_id = "add_to_cart_post"
          else:
            reg_href = reg_then_add_to_cart_link
            reg_element_id = "reg_then_add_to_cart"
          %>
          <% if ecommerce_checkout:
              reg_href = ecommerce_checkout_link
              reg_element_id = ""
          %>
          <a href="${reg_href}" class="add-to-cart" id="${reg_element_id}">
            ${_("Add {course_name} to Cart <span>({price} USD)</span>")\
              .format(course_name=course.display_number_with_default, price=course_price)}
          </a>
          <div id="register_error"></div>
        %else:
          <% 
            if ecommerce_checkout:
              reg_href = ecommerce_checkout_link
            else:
              reg_href="#"
            if professional_mode:
              href_class = "add-to-cart"
            else:
              href_class = "register"
          %>
          <a href="${reg_href}" class="${href_class}">
            ${_("Enroll Now")}
          </a>
          <div id="register_error"></div>
        %endif
          <label for="mail-check">
            <input id="mail-check" type="checkbox">
            I would like to receive email from ITT /ADPC and learn about other offerings related to Eco DRR.
          </label>
        </div>

      </section>
      % if get_course_about_section(request, course, "video"):
      <a href="#video-modal" class="media" rel="leanModal">
        <div class="hero">
          <img src="${course_image_urls['large']}" alt="" />
          <div class="play-intro"></div>
        </div>
      </a>
      %else:
      <div class="media">
        <div class="hero">
          <img src="${course_image_urls['large']}" alt="" />
        </div>
      </div>
      % endif
    </div>
      </div>
  </header>

  <div class="container">
    <div class="details">
      % if staff_access and studio_url is not None:
        <div class="wrap-instructor-info studio-view">
          <a class="instructor-info-action" href="${studio_url}">${_("View About Page in studio")}</a>
        </div>
      % endif

      <div class="inner-wrapper ugc">
        ${get_course_about_section(request, course, "overview")}
        <div class="open-box">
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quidem nam, ea, explicabo corrupti repudiandae laborum placeat minus quis doloribus quisquam sint! Facilis incidunt assumenda quo officia, magni veritatis similique tenetur!
          Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quidem nam, ea, explicabo corrupti repudiandae laborum placeat minus quis doloribus quisquam sint! Facilis incidunt assumenda quo officia, magni veritatis similique tenetur!
          Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quidem nam, ea, explicabo corrupti repudiandae laborum placeat minus quis doloribus quisquam sint! Facilis incidunt assumenda quo officia, magni veritatis similique tenetur!
          Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quidem nam, ea, explicabo corrupti repudiandae laborum placeat minus quis doloribus quisquam sint! Facilis incidunt assumenda quo officia, magni veritatis similique tenetur!
          Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quidem nam, ea, explicabo corrupti repudiandae laborum placeat minus quis doloribus quisquam sint! Facilis incidunt assumenda quo officia, magni veritatis similique tenetur!</p>
          <span class="open-box_link">see more</span>
        </div>
        <div class="content-box">
          <h2 class="content-box_header">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</h2>
            <a class="content-box_link" href="#"><img class="content-box_img" src="/static/${settings.DEFAULT_SITE_THEME}/images/cert-verified-thumb.png" alt=""></a>
            <div class="content-box_item">
              <span class="content-box_ico-holder">
                <i class="fa fa-rocket"></i>
              </span>
              <div class="content-box_text-holder">
                <h3 class="content-box_text-heading">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</h3>
                <p class="content-box_text">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Voluptatum, nemo unde! Quia temporibus cum voluptatem, quo, tempora odio, obcaecati officiis necessitatibus deleniti provident dolores suscipit corrupti deserunt sed labore. Ullam!</p>
              </div>
            </div>
            <div class="content-box_item">
              <span class="content-box_ico-holder">
                <i class="fa fa-road"></i>
              </span>
              <div class="content-box_text-holder">
                <h3 class="content-box_text-heading">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</h3>
                <p class="content-box_text">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Voluptatum, nemo unde! Quia temporibus cum voluptatem, quo, tempora odio, obcaecati officiis necessitatibus deleniti provident dolores suscipit corrupti deserunt sed labore. Ullam!</p>
              </div>
            </div>
            <div class="content-box_item">
              <span class="content-box_ico-holder">
                <i class="fa fa-trophy"></i>
              </span>
              <div class="content-box_text-holder">
                <h3 class="content-box_text-heading">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</h3>
                <p class="content-box_text">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Voluptatum, nemo unde! Quia temporibus cum voluptatem, quo, tempora odio, obcaecati officiis necessitatibus deleniti provident dolores suscipit corrupti deserunt sed labore. Ullam!</p>
              </div>
            </div>
            <div class="content-box_item">
              <span class="content-box_ico-holder">
                <i class="fa fa-heart"></i>
              </span>
              <div class="content-box_text-holder">
                <h3 class="content-box_text-heading">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</h3>
                <p class="content-box_text">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Voluptatum, nemo unde! Quia temporibus cum voluptatem, quo, tempora odio, obcaecati officiis necessitatibus deleniti provident dolores suscipit corrupti deserunt sed labore. Ullam!</p>
              </div>
            </div>
        </div>
      </div>
  </div>

    <div class="course-sidebar">
      <div class="course-summary">

        <%include file="course_about_sidebar_header.html" />

        <ol class="important-dates">
          <li class="important-dates-item"><span class="icon fa fa-info-circle" aria-hidden="true"></span><p class="important-dates-item-title">${_("Course Number")}</p><span class="important-dates-item-text course-number">${truncatechars(course.display_number_with_default, 25) | h}</span></li>
          % if not course.start_date_is_still_default:
            <li class="important-dates-item"><span class="icon fa fa-calendar" aria-hidden="true"></span><p class="important-dates-item-title">${_("Classes Start")}</p><span class="important-dates-item-text start-date">${course.start_datetime_text()}</span></li>
          % endif
            ## We plan to ditch end_date (which is not stored in course metadata),
            ## but for backwards compatibility, show about/end_date blob if it exists.
            % if get_course_about_section(request, course, "end_date") or course.end:
            <li class="important-dates-item">
                <span class="icon fa fa-calendar" aria-hidden="true"></span>
                <p class="important-dates-item-title">${_("Classes End")}</p>
                <span class="important-dates-item-text final-date">
                    % if get_course_about_section(request, course, "end_date"):
                        ${get_course_about_section(request, course, "end_date")}
                    % else:
                        ${course.end_datetime_text()}
                    % endif
                </span>
            </li>
            % endif

          % if get_course_about_section(request, course, "effort"):
            <li class="important-dates-item"><span class="icon fa fa-pencil" aria-hidden="true"></span><p class="important-dates-item-title">${_("Estimated Effort")}</p><span class="important-dates-item-text effort">${get_course_about_section(request, course, "effort")}</span></li>
          % endif

          ##<li class="important-dates-item"><span class="icon fa fa-clock-o" aria-hidden="true"></span><p class="important-dates-item-title">${_('Course Length')}</p><span class="important-dates-item-text course-length">${_('{number} weeks').format(number=15)}</span></li>

          %if course_price and (can_add_course_to_cart or is_cosmetic_price_enabled):
            <li class="important-dates-item">
              <span class="icon fa fa-money" aria-hidden="true"></span>
              <p class="important-dates-item-title">${_("Price")}</p>
              <span class="important-dates-item-text">${course_price}</span>
            </li>
          %endif

          % if pre_requisite_courses:
          <% prc_target = reverse('about_course', args=[unicode(pre_requisite_courses[0]['key'])]) %>
          <li class="prerequisite-course important-dates-item">
            <span class="icon fa fa-list-ul" aria-hidden="true"></span>
            <p class="important-dates-item-title">${_("Prerequisites")}</p>
            ## Multiple pre-requisite courses are not supported on frontend that's why we are pulling first element
            <span class="important-dates-item-text pre-requisite"><a href="${prc_target}">${pre_requisite_courses[0]['display']}</a></span>
            <p class="tip">
            ${_("You must successfully complete {link_start}{prc_display}{link_end} before you begin this course.").format(
              link_start='<a href="{}">'.format(prc_target),
              link_end='</a>',
              prc_display=pre_requisite_courses[0]['display'],
            )}
            </p>
          </li>
          % endif
          % if get_course_about_section(request, course, "prerequisites"):
            <li class="important-dates-item"><i class="icon fa fa-info-circle"></i><p class="important-dates-item-title">${_("Course Number")}</p><span class="important-dates-item-text course-number">${truncatechars(course.display_number_with_default, 25) | h}</span></li>
          % endif
        </ol>
    </div>
      ## For now, ocw links are the only thing that goes in additional resources
      % if get_course_about_section(request, course, "ocw_links"):
      <div class="additional-resources">
        <header>
          <h1>${_("Additional Resources")}</h1>
      </div>

        <div>
          ## "MITOpenCourseware" should *not* be translated
          <h2 class="opencourseware">MITOpenCourseware</h2>
             ${get_course_about_section(request, course, "ocw_links")}
        </div>
    </div>
      %endif
## CourseTalk widget
      % if show_coursetalk_widget:
      <ul style="padding: 0 0 0 0;">
      <li style="list-style: none;">
      <div class="coursetalk-read-reviews">
          <div id="ct-custom-read-review-widget" data-provider="${platform_key}" data-course="${course_review_key}"></div>
      </div>
      </li>
      </ul>
      % endif
  </div>

  </div>
</div>

## Need to put this hidden form on the page so that the registration button works.
## Since it's no harm to display a hidden form, we display it with the most permissive conditional
## which is when the student is not registered.
%if active_reg_button or is_shib_course:
  <div style="display: none;">
    <form id="class_enroll_form" method="post" data-remote="true" action="${reverse('change_enrollment')}">
      <fieldset class="enroll_fieldset">
        <legend class="sr">${_("Enroll")}</legend>
        <input name="course_id" type="hidden" value="${course.id | h}">
        <input name="enrollment_action" type="hidden" value="enroll">
      </fieldset>
      <div class="submit">
        <input name="submit" type="submit" value="${_('enroll')}">
      </div>
    </form>
  </div>
%endif

<%include file="../video_modal.html" />
